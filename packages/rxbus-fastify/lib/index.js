var e,{timeout:s}=require("rxjs/operators"),t=(e=require("fastify"))&&e.__esModule?e.default:e;require("@soulsoftware/rxmq");var n=require("fastify-websocket"),{Bus:r}=require("@soulsoftware/rxbus");function o(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}const a={WSSend:"ws.send",WSMessage:"ws.message.out",WSMessageIn:"ws.message.in",WSAdd:"ws.add",ServerStart:"server.start",ServerClose:"server.close"};exports.Subjects=a;const c=new class{constructor(){o(this,"server",t({})),o(this,"name","fastify"),o(this,"config",{port:3e3,requestTimeout:5e3})}setupWebSocketChannel(e){const s=e,t=r.channels.channel(s),n=t.subject(a.WSMessageIn),o=t.observe(a.WSMessage);this.server.get(`/${this.name}/channel/${s}/*`,{websocket:!0},((e,s)=>{e.socket.on("message",(e=>n.next(e))),o.subscribe((s=>{console.log("ws send",s),e.socket.send(s)}))}))}onRegister(e){e&&(this.config=e);const t=r.channels.replyChannel(this.name),o=new RegExp(`/${this.name}/channel/([\\w]+)([?].+)?`);this.server.get(`/${this.name}/channel/*`,(async(e,n)=>{const r=o.exec(e.url);r?t.request({topic:r[1],data:e}).pipe(s(this.config.requestTimeout||5e3)).subscribe({next:e=>n.send(e),error:e=>n.code(500).send(e),complete:()=>{}}):n.status(404).send("command not found!"),await n})),this.server.register(n,{}),r.channels.replyChannel(this.name).observe(a.WSAdd).subscribe((({data:e,replySubject:s})=>{console.log("request add channel ",e),this.setupWebSocketChannel(e),s.complete()}))}onStart(){this.server.listen(this.config.port||3e3,((e,s)=>{e?(console.error(e),r.channels.channel(this.name).subject(a.ServerStart).error(e)):(console.log(`Server listening at ${s}`),r.channels.channel(this.name).subject(a.ServerStart).next({address:s}))}))}onStop(){this.server.close().then((e=>{console.log("server closed!"),r.channels.channel(this.name).subject(a.ServerClose).complete()}))}};exports.Module=c;
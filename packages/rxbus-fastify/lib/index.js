var e,{timeout:s}=require("rxjs/operators"),t=(e=require("fastify"))&&e.__esModule?e.default:e;require("@soulsoftware/rxmq");var r=require("fastify-websocket"),{Bus:n}=require("@soulsoftware/rxbus");function o(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}const a={WSSend:"ws.send",WSMessage:"ws.message",WSAdd:"ws.add",ServerStart:"server.start",ServerClose:"server.close"};exports.Subjects=a;const c=new class{constructor(){o(this,"server",t({})),o(this,"name","fastify")}setupWebSocketChannel(e){const s=e,t=n.channels.channel(s).subject(a.WSMessage),r=t.asObservable();this.server.get(`/${this.name}/channel/${s}/*`,{websocket:!0},((e,s)=>{e.socket.on("message",(e=>t.next(e))),r.subscribe((s=>{console.log("ws send",s),e.socket.send(s)}))}))}onRegister(e){this.config=e;const t=n.channels.request(this.name),o=new RegExp(`/${this.name}/channel/([\\w]+)([?].+)?`);this.server.get(`/${this.name}/channel/*`,(async(r,n)=>{const a=o.exec(r.url);a?t.request({topic:a[1],data:r}).pipe(s((null==e?void 0:e.requestTimeout)||5e3)).subscribe({next:e=>n.send(e),error:e=>n.code(500).send(e),complete:()=>{}}):n.status(404).send("command not found!"),await n})),this.server.register(r,{}),n.channels.request(this.name).observe(a.WSAdd).subscribe((({data:e,replySubject:s})=>{console.log("request add channel ",e),this.setupWebSocketChannel(e),s.complete()}))}onStart(){var e;this.server.listen((null===(e=this.config)||void 0===e?void 0:e.port)||3e3,((e,s)=>{e?(console.error(e),n.channels.channel(this.name).subject(a.ServerStart).error(e)):(console.log(`Server listening at ${s}`),n.channels.channel(this.name).subject(a.ServerStart).next({address:s}))}))}onStop(){this.server.close().then((e=>{console.log("server closed!"),n.channels.channel(this.name).subject(a.ServerClose).complete()}))}};exports.Module=c;
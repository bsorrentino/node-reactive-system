var e,s=require("fastify-websocket"),r=(e=require("fastify"))&&e.__esModule?e.default:e,{Bus:n}=require("@soulsoftware/rxbus");function t(e,s,r){return s in e?Object.defineProperty(e,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[s]=r,e}const o=new class{constructor(){t(this,"server",r({})),t(this,"name","fastify")}onRegister(){const e=`${this.name}/channel`;this.server.register(s),this._myChannel=n.channels.requestChannel(e);const r=new RegExp(`/${e}/([\\w]+)([?].+)?`);this.server.get(`/${e}/*`,((e,s)=>{const n=r.exec(e.url);var t;n?null===(t=this._myChannel)||void 0===t||t.request({topic:n[1],data:e}).subscribe({next:e=>s.send(e),error:e=>s.code(500).send(e),complete:()=>{}}):s.status(404).send("command not found!")}))}onStart(){const e=`${this.name}/channel`;this.server.listen(8080,((s,r)=>{s?(console.error(s),n.channels.channel(e).subject("server.start").error(s)):(console.log(`Server listening at ${r}`),n.channels.channel(e).subject("server.start").next({address:r}))}))}onStop(){this.server.close().then((e=>console.log("server closed!")))}};exports.Module=o;